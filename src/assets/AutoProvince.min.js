/*
Author : Witoon Pomipon
Email : codebee2014@gmail.com
Website : codebee.co.th
Blogs : codebee.co.th/labs
Company : codebee company limited
*/

;(function( $ ){
	$.fn.AutoProvince = function( options ) {
		var Setting = $.extend( {
			PROVINCE:		'#province', // select div สำหรับรายชื่อจังหวัด
			AMPHUR:			'#amphur', // select div สำหรับรายชื่ออำเภอ
			DISTRICT:		'#district', // select div สำหรับรายชื่อตำบล
			POSTCODE:		'#postcode', // input field สำหรับรายชื่อรหัสไปรษณีย์
			GEOGRAPHY:		'#geography', // input field สำหรับรายชื่อรหัสไปรษณีย์
			arrangeByName:		false // กำหนดให้เรียงตามตัวอักษร
		}, options);
		
		return this.each(function() {
			var _province,_amphure,_district,_zipcode,_geography;
			var provinceUrl = "/src/assets/json/zipcodes.json";
			var amphureUrl = "/src/assets/json/amphures.json";
			var districtUrl = "/src/assets/json/districts.json";
			var zipcodeUrl = "/src/assets/json/zipcodes.json";
			var geographyUrl = "/src/assets/json/geography.json";
			
			$(function() {
				initialize();
			});
			function initialize(){
				$.when(
					$.getJSON(provinceUrl),
					$.getJSON(amphureUrl),
					$.getJSON(districtUrl),
					$.getJSON(zipcodeUrl),
					$.getJSON(geographyUrl)
				).done(function(province,amphure,district,zipcode,geography) {
					_province = province[0];
					_amphure = amphure[0];
					_district = district[0];
					_zipcode = zipcode[0];
					_geography = geography[0];
					_loadProvince();
					addEventList();
				});
			}
			
			function _loadProvince()
			{
				var list = [];
				var geo_id;
				_province.forEach(function(element) {
				  list.push({id:element.province_id,name:element.province_name,geo_id:element.geo_id});
				  geo_id = element.geo_id;
				});
				
				if(Setting.arrangeByName){
					AddToView(list.sort(SortByName),Setting.PROVINCE);
				}else{
					AddToView(list,Setting.PROVINCE);
				}
				
			}
			
			function _loadAmphur(PROVINCE_ID_SELECTED)
			{
				var list = [];
				var isFirst = true;
				$(Setting.AMPHUR).empty();
				var amphure = $.grep(_amphure, function(e){ return e.province_id == PROVINCE_ID_SELECTED; });
				amphure.forEach(function(element) {
				  	list.push({id:element.amphur_id,name:element.amphur_name,postcode:element.amphur_code,geo_id:element.geo_id});
				  	if(isFirst){
						isFirst = false;
						_loadDistrict(element.amphur_id);
						//$(Setting.POSTCODE).val(element.amphur_code);
				  	}
				});
				//console.log(list);
				AddToView(list,Setting.AMPHUR);
				/*if(Setting.arrangeByName){
					AddToView(list.sort(SortByName),Setting.AMPHUR);
				}else{
					AddToView(list,Setting.AMPHUR);
				}*/
			}
			
			function _loadDistrict(AMPHUR_ID_SELECTED)
			{
				
				
				
					
				var list = [];
				var isFirst = true;
				$(Setting.DISTRICT).empty();
				
				var district = $.grep(_district, function(e){ return e.amphur_id == AMPHUR_ID_SELECTED; });
				district.forEach(function(element) {
				  	list.push({id:element.district_id,name:element.district_name,geo_id:element.geo_id,district_code:element.district_code});
				    if(isFirst){
						isFirst = false;
						var postcode = $.grep(_zipcode, function(e){ return e.district_code == element.district_code; });
						var zipcode_name = postcode[0].zipcode_name;
						$(Setting.POSTCODE).val(zipcode_name);
					
				  	}
				});
				
				AddToView(list,Setting.DISTRICT);
				
				
				
			}
			
			function _loadZipcode(AMPHUR_ID_SELECTED)
			{
				var list = [];
				$(Setting.DISTRICT).empty();
				var district = $.grep(_district, function(e){ return e.amphur_id == AMPHUR_ID_SELECTED; });
				district.forEach(function(element) {
				  	list.push({id:element.district_id,name:element.district_name,geo_id:element.geo_id});
				  	//$(Setting.POSTCODE).val(element.district_code);
				});
				
				if(Setting.arrangeByName){
					AddToView(list.sort(SortByName),Setting.DISTRICT);
				}else{
					AddToView(list,Setting.DISTRICT);
				}
			}
			function _loadGeo(GEO_ID)
			{
				var geo = $.grep(_geography, function(e){ return e.geo_id == GEO_ID; });
				var geo_name = geo[0].geo_name;
				
				$(Setting.GEOGRAPHY).val(geo_name);	
			}
			function addEventList(){
				$(Setting.PROVINCE).change(function(e) {
					var PROVINCE_ID = $(this).val();
					var GEO_ID = $(this).find('option:selected').attr("GEO");
					
					_loadAmphur(PROVINCE_ID);
					_loadGeo(GEO_ID);
				});
				$(Setting.AMPHUR).change(function(e) {
					var AMPHUR_ID = $(this).val();
					//$(Setting.POSTCODE).val($(this).find('option:selected').attr("POSTCODE"));
					_loadDistrict(AMPHUR_ID);
				});	
				
				$(Setting.DISTRICT).change(function(e) {
					var district_code = $(this).find('option:selected').attr("district_code");
					var postcode = $.grep(_zipcode, function(e){ return e.district_code == district_code; });
					var zipcode_name = postcode[0].zipcode_name;
					$(Setting.POSTCODE).val(zipcode_name);
				});	
			}
			function AddToView(list,key){
				for (var i = 0;i<list.length;i++) {
					if(key != Setting.DISTRICT){
						$(key).append("<option value='"+list[i].id+"' district_code='"+list[i].district_code+"' GEO='"+list[i].geo_id+"'>"+list[i].name+"</option>");	
					}else{
						$(key).append("<option value='"+list[i].id+"' district_code='"+list[i].district_code+"'>"+list[i].name+"</option>");	
					}
				}
			}
			function SortByName(a, b){
			  var aName = a.name.toLowerCase();
			  var bName = b.name.toLowerCase(); 
			  return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
			}
		});
	};
})( jQuery );
